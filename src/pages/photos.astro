---
import Layout from "../layouts/Layout.astro";
import { Picture } from "astro:assets";
import { stat } from "node:fs/promises";
import { join } from "node:path";

import type { ImageMetadata } from "astro";

const titles: Record<string, string> = {};

const files = import.meta.glob("../../photos/*.jpg");
const photos = [];
const dirname = new URL(".", import.meta.url).pathname;

for await (const [filepath, file] of Object.entries(files)) {
  const photo = ((await file()) as any).default as ImageMetadata;
  const stats = await stat(join(dirname, filepath));
  const filename = filepath.split("/").pop()!;

  photos.push({
    title: titles?.[filename],
    meta: photo,
    createdAt: stats.birthtime,
  });
}

console.log(photos);
---

<Layout floatingHeader title="Photos">
  <main>
    <div>
      {
        photos.map((photo) => (
          <figure class="photo">
            <Picture
              widths={[400, 800, 1600]}
              src={photo.meta}
              decoding="async"
              quality={90}
              loading="lazy"
              formats={["avif", "webp"]}
              alt={""}
            />
            <figcaption>
              <a href={photo.meta.src} download>
                download
              </a>
            </figcaption>
          </figure>
        ))
      }
    </div>
  </main>
</Layout>

<style>
  main {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 5rem 2rem;

    > div {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .photo {
      margin: 0;
      position: relative;

      figcaption {
        opacity: 0;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        color: white;
        padding: 1rem;
        transition: opacity 0.3s;
        display: flex;

        a {
          margin-left: auto;
        }
      }

      &:hover figcaption {
        opacity: 1;
      }

      img {
        max-width: 60rem;
        height: auto;
      }
    }
  }
</style>
